{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h2>Live Trend {% if selected_trend_label %}<small class="text-muted">({{ selected_trend_label }})</small>{% endif %}</h2>
                {% if selected_segment_label %}
                <p class="text-muted mb-0">Segment: {{ selected_segment_label }}</p>
                {% endif %}
            </div>
            <div class="card-body">
                <form id="forecast-form">
                    <div class="mb-3">
                        <label for="forecast_month" class="form-label">Trend month (YYYY-MM)</label>
                        <input type="text" class="form-control" id="forecast_month" placeholder="2025-08">
                    </div>
                    
                    <div class="mb-3">
                        <label for="day_to_forecast" class="form-label">Day of month</label>
                        <input type="number" class="form-control" id="day_to_forecast" min="1" max="31">
                    </div>
                    
                    <div class="mb-3">
                        <label for="current_mtd" class="form-label">Current {{ selected_trend_metric_label or 'Metric' }} MTD</label>
                        <input type="number" class="form-control" id="current_mtd" step="0.01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="n_months_to_use" class="form-label">History window (months)</label>
                        <input type="number" class="form-control" id="n_months_to_use" min="1" value="6">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Generate Trend</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div id="result-container" style="display: none;">
            <div class="card result-card">
                <div class="card-header">
                    <h3>Trend</h3>
                </div>
                <div class="card-body">
                    <h4>Predicted total ({{ selected_trend_metric_label or 'Metric' }}): <span id="predicted-total"></span></h4>
                    <p>Avg margin of error: <span id="margin-of-error"></span></p>
                    <div id="avg-percent-wrapper" style="display: none;">
                        <p>Average percent complete: <span id="avg-percent"></span> (<span id="avg-percent-decimal"></span>)</p>
                        <p id="calc-forecast-line" class="mb-0"></p>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="history-toggle" style="display: none;">Show Details</button>
                    <div id="history-container" class="mt-3" style="display: none;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Source Month</th>
                                    <th>Percent Complete</th>
                                    <th>MTD</th>
                                    <th>Actual Total</th>
                                    <th>Implied Forecast</th>
                                </tr>
                            </thead>
                            <tbody id="history-rows"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="error-container" style="display: none;">
            <div class="card error-card">
                <div class="card-header">
                    <h3>Error</h3>
                </div>
                <div class="card-body">
                    <p id="error-message"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const metricLabel = {{ (selected_trend_metric_label or 'Metric') | tojson }};
    // Set default values based on the reference script
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const defaultMonth = yesterday.toISOString().slice(0, 7); // YYYY-MM format
    $('#forecast_month').val(defaultMonth);
    
    // Set default day based on yesterday's date if it's the same month
    if (yesterday.toISOString().slice(0, 7) === defaultMonth) {
        $('#day_to_forecast').val(yesterday.getDate());
    }
    
    $('#forecast-form').on('submit', function(e) {
        e.preventDefault();
        
        // Get form values
        let forecast_month = $('#forecast_month').val();
        let day_to_forecast = $('#day_to_forecast').val();
        const current_mtd = $('#current_mtd').val();
        const n_months_to_use = $('#n_months_to_use').val() || 6;
        const currentMtdNumber = Number(current_mtd || 0);
        
        // Use defaults if values are empty (like in the reference script)
        if (!forecast_month) {
            forecast_month = defaultMonth;
        }
        
        if (!day_to_forecast && yesterday.toISOString().slice(0, 7) === forecast_month) {
            day_to_forecast = yesterday.getDate();
        }
        
        // Validate required fields
        if (!current_mtd) {
            alert('Current ' + metricLabel + ' MTD is required');
            return;
        }
        
        // Hide previous results
        $('#result-container').hide();
        $('#error-container').hide();
        $('#history-container').hide();
        $('#history-toggle').hide().text('Show Details');
        $('#avg-percent-wrapper').hide();
        $('#history-rows').empty();
        $('#calc-forecast-line').text('');
        
        console.log('Sending request with:', {
            forecast_month: forecast_month,
            day_to_forecast: day_to_forecast,
            current_mtd: current_mtd,
            n_months_to_use: n_months_to_use
        });
        
        // Send request to API
        $.ajax({
            url: '/api/live_forecast',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                forecast_month: forecast_month,
                day_to_forecast: day_to_forecast,
                current_mtd: current_mtd,
                n_months_to_use: n_months_to_use
            }),
            success: function(data) {
                console.log('Success response:', data);
                // Display results
                $('#predicted-total').text(parseFloat(data.forecast).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                $('#margin-of-error').text((parseFloat(data.avg_margin_of_error) * 100).toFixed(2) + '%');

                const avgPercentComplete = data.avg_percent_complete || 0;
                if (avgPercentComplete > 0) {
                    $('#avg-percent').text((avgPercentComplete * 100).toFixed(3) + '%');
                    $('#avg-percent-decimal').text(avgPercentComplete.toFixed(6));
                    $('#avg-percent-wrapper').show();
                    const calcForecast = currentMtdNumber / avgPercentComplete;
                    if (isFinite(calcForecast)) {
                        $('#calc-forecast-line').text('Forecast calculation: ' + currentMtdNumber.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' / ' + avgPercentComplete.toFixed(6) + ' = ' + calcForecast.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                    }
                }

                const history = data.history || [];
                if (history.length) {
                    history.forEach(function(item) {
                        const pct = ((item.percent_complete || 0) * 100).toFixed(3) + '%';
                        const mtd = Number(item.mtd || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
                        const actual = Number(item.actual_total || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
                        const implied = Number(item.implied_forecast || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
                        $('#history-rows').append(
                            '<tr>' +
                                '<td>' + item.source_month + '</td>' +
                                '<td>' + pct + '</td>' +
                                '<td>' + mtd + '</td>' +
                                '<td>' + actual + '</td>' +
                                '<td>' + implied + '</td>' +
                            '</tr>'
                        );
                    });
                    $('#history-toggle').show();
                }
                $('#result-container').show();
            },
            error: function(xhr) {
                console.log('Error response:', xhr);
                // Display error
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    $('#error-message').text(errorData.error);
                } catch (e) {
                    $('#error-message').text('An unknown error occurred');
                }
                $('#error-container').show();
            }
        });
    });
});

$('#history-toggle').on('click', function() {
    const isVisible = $('#history-container').is(':visible');
    if (isVisible) {
        $('#history-container').hide();
        $(this).text('Show Details');
    } else {
        $('#history-container').show();
        $(this).text('Hide Details');
    }
});
</script>
{% endblock %}
